{% extends "base.html" %}

{% block title %}
<title>Report Bribe</title>
{% endblock %}

{% block extra_js %}
<script>

    document.addEventListener('DOMContentLoaded', () => { 
        document.getElementById('bribeReportedBanner').style.display = 'none'; 
    });

    function showBribeReportedBanner(bribeId) {
        const reportingIdElem = document.getElementById('reportingId');
        const banner = document.getElementById('bribeReportedBanner');
        if (reportingIdElem && banner) {
            reportingIdElem.textContent = bribeId;
            banner.style.display = 'block';
        } else {
            alert('Bribe reported, but could not display Reporting ID banner.');
        }
    }

    function hideBribeReportedBanner() {
        document.getElementById('bribeReportedBanner').style.display = 'none';
    }

    // Submit the form via AJAX using submitReport(event)
    function submitReport(event) {
        event.preventDefault();
        const form = document.getElementById('reportBribeForm');
        const formData = new FormData(form);

        fetch('/report_bribe', {
            method: 'POST',
            body: formData,
        })
        .then(async response => {
            if (response.ok) {
                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    alert('Bribe reported, but could not parse server response.');
                    return;
                }
                if (data && data.bribe_id) {
                    showBribeReportedBanner(data.bribe_id);
                } else {
                    showBribeReportedBanner(null); // Will show error fallback
                }
                form.reset();
            } else {
                let errorMsg = 'Error reporting bribe. Please try again.';
                try {
                    const errData = await response.json();
                    if (errData && errData.error) {
                        errorMsg = errData.error;
                    }
                } catch (e) {}
                alert(errorMsg);
            }
        })
        .catch(error => {
            console.error('Network error:', error);
            alert('Network error. Please try again.');
        });
    }
    

    document.addEventListener('DOMContentLoaded', () => {
        const reportForm = document.getElementById('reportBribeForm');
        if (reportForm) {
            reportForm.addEventListener('submit', submitReport);
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        const reportForm = document.querySelector('.form-grid');
        reportForm.addEventListener('submit', submitReport);
    });
</script>
<script src="/static/states.js"></script>
<script src="static/track_bribe.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        stateDistrict('state', 'district');
    });
</script>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/report.css">
{% endblock %}

{% block button %}
<div class="subheader">
    <a href="/"> <button class="button-primary"> Home </button></a> 
</div>
{% endblock %}

{% block welcome_message %}
<span class="welcome-message">Welcome, {{ current_user.user_metadata.get('username', 'User') }}!</span>
{% endblock %}

{% block content %}
<div id="banner-container">
    
</div>
<div class="table-container">
    <h1>Report Bribe:</h1>
    <form method="POST" enctype="multipart/form-data" class="form-grid" action="/report_bribe" id="reportBribeForm">
        <!-- Required Fields -->
        
        <label for="official">Official's Name: </label>
        <input type="text" id="official" name="official">

        <label for="department">Department:</label>
        <input type="text" id="department" name="department" required>

        <label for="amount">Bribe Amount: (â‚¹):</label>
        <input type="text" id="amount" name="amount" required min="10" pattern="[0-9]+">

        <label for="pincode">PIN Code:</label>
        <input type="text" id="pincode" name="pincode" pattern="[0-9]{6}">

        <label for="state">State/UT:</label>
        <select id="state" name="state" required class="state-selector">
            <option value="state">Select State/UT</option>
        </select>

        <label for="district">District:</label>
        <select id="district" name="district" required class="district-selector" disabled>
            <option value="">Select State First</option>
        </select>

        <label for="description">Description:</label>
        <textarea id="description" name="description" rows="4" required></textarea>

        <!-- Optional Fields -->
        <label for="date">Date of Incident:</label>
        <input type="date" id="date" name="date" max="{{current_date}}" value="">
         
        <label for="evidence">Evidence Upload:</label>
        <input type="file" id="evidence" name="evidence_files" accept=".pdf,.jpg,.png" multiple>

        <button type="submit" class="button-primary">Submit Report</button>
    </form>
</div>
<script>

</script>
</div>

<!-- Bribe Reported Banner -->
<div id="bribeReportedBanner" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="hideBribeReportedBanner()">&times;</span>
        <h2 style="color: green; margin-bottom: 15px;">Bribe Reported Successfully!</h2>
        <p style="text-align: center;">Your Reporting ID is:  <span id="reportingId"></span></p>
        <p>Use this Reporting ID or your username to track bribes later </p>
    </div>
</div>
{% endblock %}