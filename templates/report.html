{% extends "base.html" %}

{% block title %}
<title>Report Bribe</title>
{% endblock %}

{% block extra_js %}
<script src="/static/mdrm.js"></script>
<script>

    document.addEventListener('DOMContentLoaded', () => { 
        document.getElementById('bribeReportedBanner').style.display = 'none'; 
    });

    function showBribeReportedBanner(bribeId) {
        const reportingIdElem = document.getElementById('bribeReportSuccessId');
        const banner = document.getElementById('bribeReportedBanner');
        if (reportingIdElem && banner) {
            reportingIdElem.textContent = bribeId || 'N/A';
            banner.style.display = 'flex';
        } else {
            alert('Bribe reported, but could not display Reporting ID banner.');
        }
    }

    function hideBribeReportedBanner() {
        document.getElementById('bribeReportedBanner').style.display = 'none';
    }

    async function submitReport(event) {
        event.preventDefault();
        const form = document.getElementById('reportBribeForm');
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'Processing...';

        try {
            const processedFormData = await processFormData('reportBribeForm', 'evidence_files');

            const response = await fetch('/report_bribe', {
                method: 'POST',
                body: processedFormData,
            });

            if (response.ok) {
                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    alert('Bribe reported, but could not parse server response.');
                    form.reset();
                    return;
                }
                if (data && data.bribe_id) {
                    showBribeReportedBanner(data.bribe_id);
                } else {
                    showBribeReportedBanner(null);
                }
                form.reset();
            } else {
                let errorMsg = `${error.error} : ${error.message}. Please try again.`;
                try {
                    const errData = await response.json();
                    if (errData && errData.error) {
                        errorMsg = errData.error;
                    }
                } catch (e) {
                    console.error("Server returned error status, and failed to parse error response:", e);
                }
                alert(errorMsg);
            }
        } catch (error) {
            console.error('Error during form processing or network request:', error);
            alert(`An error occurred: ${error.message || 'Network error. Please check console and try again.'}`);
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Submit Report';
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        const reportForm = document.getElementById('reportBribeForm');
        if (reportForm) {
            reportForm.addEventListener('submit', submitReport);
        } else {
            console.error("Could not find form with ID reportBribeForm to attach listener.");
        }

        if (typeof stateDistrict === 'function') {
            stateDistrict('state', 'district');
        } else {
            console.error("stateDistrict function not found. State/District dropdowns may not work.");
        }
    });

</script>
<script src="/static/states.js"></script>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/report.css">
{% endblock %}

{% block button %}
<div class="subheader">
    <a href="/"> <button class="button-primary"> Home </button></a> 
</div>
{% endblock %}

{% block welcome_message %}
<span class="welcome-message">Welcome, {{ current_user.user_metadata.get('username', 'User') }}!</span>
{% endblock %}

{% block content %}
<div class="table-container">
    <h1>Report Bribe:</h1>
    <form method="POST" enctype="multipart/form-data" class="form-grid" action="/report_bribe" id="reportBribeForm">
        <!-- Required Fields -->
        
        <label for="official">Official's Name: </label>
        <input type="text" id="official" name="official">

        <label for="department">Department:</label>
        <input type="text" id="department" name="department" required>

        <label for="amount">Bribe Amount: (â‚¹):</label>
        <input type="number" id="amount" name="amount" required min="10" 
               oninvalid="this.setCustomValidity('Amount must be in numbers and at least 10')" 
               oninput="this.setCustomValidity('')" pattern="[0-9]+">

        <label for="pincode">PIN Code:</label>
        <input type="text" id="pincode" name="pincode" pattern="[0-9]{6}" 
               oninvalid="this.setCustomValidity('Pincode must be 6 digits')" 
               oninput="this.setCustomValidity('')">

        <label for="state">State/UT:</label>
        <select id="state" name="state" required class="state-selector">
            <option value="">Select State/UT</option>
        </select>

        <label for="district">District:</label>
        <select id="district" name="district" required class="district-selector" disabled>
            <option value="">Select State First</option>
        </select>

        <label for="description">Description:</label>
        <textarea id="description" name="description" rows="4" required></textarea>

        <!-- Optional Fields -->
        <label for="date">Date of Incident:</label>
        <input type="date" id="date" name="date" max="{{current_date}}" value="">
         
        <label for="evidence">Evidence Upload (PDF, JPG, PNG):</label>
        <input type="file" id="evidence" name="evidence_files" accept=".pdf,.jpg,.jpeg,.png" multiple>

        <button type="submit" class="button-primary">Submit Report</button>
    </form>
</div>

<!-- Bribe Reported Banner -->
<div id="bribeReportedBanner" class="modal">
    <div class="modal-content">
        <span class="close" onclick="hideBribeReportedBanner()">&times;</span>
        <h2 style="color: green; margin-bottom: 15px;">Bribe Reported Successfully!</h2>
        <p style="text-align: center;">Your Reporting ID is:  <span id="bribeReportSuccessId"></span></p>
        <br>
        <p>Use this Reporting ID or your username to track bribes later </p>
    </div>
</div>
{% endblock %}